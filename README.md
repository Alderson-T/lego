# lego
## 简介

## 分布式基础概念
集群是个物理形态，分布式是个工作方式
远程调用：在分布式系统中，各个服务可能处于不同主机，但是服务之间不可避免的相互调用，称之为远程调用，Spring Cloud中使用HTTP+JSON的方式完成远程调用
### 服务注册/发现&注册中心
A服务调用B服务，A服务并不知道B服务当前在哪几台服务器有，哪些是正常的，哪些服务已经下线。解决这个问题可以引入注册中心。
配置中心用来管理微服务的配置信息。
### 服务熔断&服务降级
在微服务架构中，微服务之间通过网络进行通信，存在相互依赖，当其中一个服务不可用时，有可能会造成雪崩效应。要防止这样的情况，必须要有容错机制来保护服务。
情景：
订单服务 -> 商品服务 -> 库存服务
库存服务出现故障导致响应慢，导致商品服务需要等待，可能等到10s后库存服务才能响应。库存服务的不可用导致商品服务阻塞，商品服务等待期间，订单服务也处于阻塞。一个服务不可用导致整个服务链都阻塞。如果是高并发，第一个请求调用后阻塞10s得不到结果，第二个请求直接阻塞10s。更多的请求进来导致请求积压，全部阻塞，最终服务器的资源耗尽。导致雪崩
解决方法：
1. 服务熔断
	指定超时时间，库存服务3s没有响应就超时，如果经常失败，比如10s内100个请求都失败了。开启断路保护机制，下一次请求进来不调用库存服务了，因为上一次100%错误都出现了，我们直接在此中断，商品服务直接返回，返回一些默认数据或者null，而不调用库存服务了，这样就不会导致请求积压。
	设置服务的超时，当被调用的服务经常失败到达某个阈值，我们已经开启断路保护机制，后来的请求不再去调用这个服务。本地直接返回默认的数据
2. 服务降级
	在运维期间，当系统处于高峰期，系统资源紧张，我们可以让非核心业务降级运行。降级：某些服务不处理，或者处理简单，比如抛异常、返回null、调用Mock数据、调用Fallback处理逻辑
### API网关
客户端发送请求到服务器路途中，设置一个网关，请求都先到达网关，网关对请求进行统一认证（合法非法）和处理等操作。在微服务架构中，API gateway作为整体架构的重要组件，它抽象了微服务中都需要的公共功能，同事提供了客户端负载均衡，服务自动熔断，灰度发布，统一认证，限流流控，日志统计等丰富的功能，帮助我们解决很多API管理难题。
![image](https://imgconvert.csdnimg.cn/aHR0cHM6Ly9mZXJtaGFuLm9zcy1jbi1xaW5nZGFvLmFsaXl1bmNzLmNvbS9pbWcvMjAyMDA2MjIyMTMwMDMuanBn?x-oss-process=image/format,png)
现如今都是前后端分离开发，分为内网部署和外网部署，外网是面向公众访问的，部署前端项目，可以有手机APP，电脑网页；内网部署的后端集群，前端在页面上操作发送请求到后端，在这途中经过Nginx集群，Nginx把请求转交给API网关，网关可以根据当前请求动态地路由到指定的服务，看当前请求是想调用商品服务还是购物车服务器出现问题也可以在网关层面对服务进行熔断或降级，网关还有其他的功能如认证授权、限流等
到达服务器后进行处理，服务于服务可能会互相调用，有些请求可能经过登录才能进行，服务可能保存了一些数据或者需要使用缓存，我们使用redis集群（分片+哨兵集群）。持久化使用mysql，读写分离和分库分表。
服务和服务之间会使用消息队列，来完成异步解耦，分布式事务的一致性，有些服务可能需要全文检索，检索商品信息，使用ElasticSearch。
服务可能会存取数据，使用阿里云的对象存储服务OSS。
项目上线后为了快速定位问题，使用ELK对日志进行处理，使用LogStash收集业务的各种日志，把日志存储到ES中，用Kibana可视化界面从ES中检索出相关信息，帮助我们快速定位问题所在。
在分布式系统中，由于我们每个服务都可能部署在很多台机器，服务和服务可能互相调用，就得知道彼此都在哪里，所以需要将所有服务都注册到注册中心。服务从注册中心发现其他服务所在位置
每个服务的配置众多为了实现改一处配置相同配置就同步更改，就需要配置中心，也是用阿里的Nacos，携程的Apollo，服务从配置中心中动态的取配置。
服务追踪，追踪服务调用链哪里出现问题，使用Spring Cloud提供的Sleuth、Zipkin、Metrics，把每个服务的信息交个开源的Prometheus进行聚合分析，再由Grafana进行可视化展示，提供Prometheus提供的AlterManager实时得到服务的告警信息，以短信/邮件的方式告知服务开发人员。
还提供了持续集成和部署。项目发布起来后，因为微服务众多，每一个都打包部署到服务器太麻烦，有了持续集成后开发人员可以将修改后的代码提交到github，运维人员可以通过自动化工具Jenkins Pipeline将github中代码打包成docker镜像，最终是由k8s集成docker服务，将服务以docker容器的方式运行。
### 微服务划分图
![image](https://imgconvert.csdnimg.cn/aHR0cHM6Ly9mZXJtaGFuLm9zcy1jbi1xaW5nZGFvLmFsaXl1bmNzLmNvbS9pbWcvMjAyMDA2MjQxMzUyNTQucG5n?x-oss-process=image/format,png)

反映了需要创建的微服务以及相关技术。
- 商品服务：商品的增删改查、商品的上下架、商品详情
- 支付服务
- 用户服务：用户的个人中心、收货地址
- 仓储服务：商品的库存
- 秒杀服务
- 订单服务
- 检索服务
- 中央认证服务
- 购物车服务
- 后台管理系统

## 环境搭建
### Docker安装
```shell

```


